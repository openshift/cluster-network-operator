{{if .IPsecMachineConfigEnable}}
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: master
  annotations:
    user-ipsec-machine-config: "true"
  name: 80-ipsec-master-extensions
spec:
  osImageURL: quay.io/pepalani/ipsec-rhcos-layered-image:nm-libreswan-fix
  config:
    ignition:
      version: 3.2.0
    systemd:
      units:
      - name: ipsecenabler.service
        enabled: true
        contents: |
         [Unit]
         Description=Enable ipsec service after os extension installation
         Before=kubelet.service

         [Service]
         Type=oneshot
         ExecStartPre=systemd-tmpfiles --create /usr/lib/rpm-ostree/tmpfiles.d/libreswan.conf
         ExecStart=systemctl enable --now ipsec.service

         [Install]
         WantedBy=multi-user.target
{{end}}
